{"filter":false,"title":"material.js","tooltip":"/public/js/material.js","undoManager":{"mark":48,"position":48,"stack":[[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":256,"column":3},"action":"insert","lines":["var Order = {","\tpositions: [],","\tonUpdate: function() {","\t\tvar html = '<h2 class=\"text-center\">Состав заказа</h2>',","\t\tfields = ['<div class=\"row text-left form-inline\">',","\t\t\t\t\t\t\t'<div class=\"col-md-6\">',","\t\t\t\t\t\t\t\t'<div class=\"form-group\">',","    \t\t\t\t\t\t\t\t'<label for=\"name\"> Как Вас зовут? </label>',","\t\t\t\t\t\t\t\t\t'<input id=\"name\" type=\"text\" class=\"form-control\" style=\"margin-left:20px\">',","\t\t\t\t\t\t\t\t'</div>',","\t\t\t\t\t\t\t'</div>',","\t\t\t\t\t\t\t'<div class=\"col-md-6\">',","\t\t\t\t\t\t\t\t'<div class=\"form-group\">',","\t\t\t\t\t\t\t\t\t'<label for=\"contact\">Email/Телефон </label>',","\t\t\t\t\t\t\t\t\t'<input id=\"contact\" type=\"text\" class=\"form-control\" style=\"margin-left:20px\">',","\t\t\t\t\t\t\t\t'</div>',","\t\t\t\t\t\t\t'</div>',","\t\t\t\t\t'</div>',","\t\t\t\t\t'<hr>',","\t\t\t\t\t'<div class=\"row\">',","\t\t\t\t\t\t'<div class=\"col-md-12\">',","\t\t\t\t\t\t\t'<div class=\"form-group\">',","\t\t\t\t\t\t\t\t'<label for=\"comment\">Комментарии к заказу</label>',","\t\t\t\t\t\t\t\t'<textarea class=\"form-control\" id=\"comment\" rows=\"5\"></textarea>',","\t\t\t\t\t\t\t'</div>',","\t\t\t\t\t\t'</div>',","\t\t\t\t\t'</div>',","\t\t\t\t\t'<div class=\"row\">',","\t\t\t\t\t\t\t'<div class=\"col-md-2 col-md-offset-5\">',","\t\t\t\t\t\t\t\t'<div class=\"form-group\">',","\t\t\t\t\t\t\t\t\t'<button type=\"submit\" class=\"btn btn-primary\" id=\"send\">Отправить заказ</button>',","\t\t\t\t\t\t\t\t'</div>',","\t\t\t\t\t\t\t'</div>',","\t\t\t\t\t\t'</div>'].join('');","\t\tthis.positions.forEach(function(el, ind) {","\t\t\thtml += '<hr><div class=\"row\"><div class=\"col-md-4\"><p>' + el.material + '</p></div><div class=\"col-md-4\"><p>' + el.count + ' шт.</p></div><div class=\"col-md-4\"><p>' + el.subtotal + ' руб.</p></div></div>';","\t\t});","\t\thtml += '<hr><div class=\"row\"><div class=\"col-md-12\"><p class=\"text-center\">Итоговая стоимость заказа: ' + this.total + ' руб.</p></div></div><hr>';","\t\thtml += fields;","\t\t$('#order').html(html);","\t\t$('#send').click(function(e) {","\t\t\tvar send1 = false, send2 = false;","            if ($('#name').val() === null || $('#name').val() === '') {","            \t$('#name').closest('.form-group').addClass('has-error');","            } else {","                $('#name').closest('.form-group').removeClass('has-error');","                send1 = true;","            }","            if ($('#contact').val() === null || $('#contact').val() === '') {","                $('#contact').closest('.form-group').addClass('has-error');","            } else {","                $('#contact').closest('.form-group').removeClass('has-error');","                send2 = true;","            }","            if (send1 && send2) {","            \tOrder.send();","            }","        });","\t},","\t","\ttotal: 0,","\t","\tadd: function(material, count, price) {","\t\tvar found = false;","\t\tthis.positions.forEach(function(el, ind) {","\t\t\tif (el.material === material) {","\t\t\t\tfound = true;","\t\t\t\tel.count += +count;","\t\t\t\tel.subtotal += count*price;","\t\t\t}","\t\t});","\t\tif (!found) {","\t\t\tthis.positions.push({material: material, count: +count, price: price, subtotal: count*price});","\t\t}","\t\tthis.total += count*price;","\t\tthis.onUpdate();","\t},","\t","\tsend: function() {","\t\tthis.positions.forEach(function(el,ind) {","\t\t\t$.ajax({","\t\t\t\turl: \"/api/order\",","\t\t\t\ttype: \"POST\",","\t\t\t\tdata: {","\t\t\t\t\tmaterial: el.material,","\t\t\t\t\tqty: el.count,","\t\t\t\t\tprice: el.price,","\t\t\t\t\tname: $('#name').val(),","\t\t\t\t\tcontact: $('#contact').val(),","\t\t\t\t\tcomment: $('#comment').val()","\t\t\t\t},","\t\t\t\tsuccess: function(resp) {","\t\t\t\t\tconsole.log(resp);","\t\t\t\t\tOrder.dz.options.url = \"/api/order/\" + resp + \"/savefile\";","\t\t\t\t\tOrder.dz.processQueue();","\t\t\t\t},","\t\t\t\terror: function(resp) {","\t\t\t\t\tconsole.log(resp);","\t\t\t\t}","\t\t\t});","\t\t});","\t}","};","","var Calc = {","    onLoad: function(obj) {","    \tvar vol = Number(obj.volume).toPrecision(3);","        $.ajax({","        \turl: \"/api/materials/printer/\" + $(\"#name\").text(),","        \ttype: \"get\",","        \tsuccess: function(resp) {","        \t\tvar mtrls = JSON.parse(resp);","        \t\tconsole.log(mtrls);","        \t\tmtrls.forEach(function(val,ind) {","        \t\t$(\"#total\").append([","        \t\t        \"<hr><div class='row'>\",","        \t\t\t        \"<div class='col-md-2'>\",","        \t\t\t\t        \"<img class='img-responsive' src='\" + val.thumbs[0] + \"'>\",","        \t\t\t        \"</div>\",","        \t\t\t        \"<div class='col-md-5'>\",","        \t\t\t\t        \"<h3 class='text-left'>\" + val.name + \"</h3>\",","        \t\t\t        \"</div>\",","        \t\t\t        \"<div class='col-md-3'>\",","        \t\t\t        \t\"<input type='number' class='form-control' value='1' style='width:50%; display: inline'> шт. <hr>\",","        \t\t\t            \"<button data-material='\" + val.name + \"' data-price='\" + Math.ceil( val.price * vol ) + \"' class='btn btn-xs btn-primary order'>Добавить к заказу</button>\",","        \t\t\t        \"</div>\",","        \t\t\t        \"<div class='col-md-2'>\",","        \t\t\t\t        \"<p>\" + Math.ceil( val.price * vol ) + \" руб.</p>\",","        \t\t\t        \"</div>\",","        \t\t        \"</div>\"].join(''));","        \t\t});","        \t\t$('.order').click(function(e) {","            \t\tvar price = $(e.currentTarget).data('price'), material = $(e.currentTarget).data('material'), count = $(e.currentTarget).parent().find('input').val();","                \tOrder.add(material, count, price);","        \t\t});","        \t}","        });","        $('#cost').modal('show');","        $(\"#props\").append(\"Объем: \" + vol + \" куб. см. <hr>\");","        $(\"#total\").append(\"<h2>Стоимость печати: </h2>\");","    },","    ","    readFile: function(file) {","        var reader = new FileReader();","        var isAscii = true;","        reader.onloadend = function(file) {","            var buf = reader.result,","    \t        view = new Uint8Array( buf ),","    \t        str = '';","    \t    for (var i=0, len = view.length; i<len; i++) {","    \t\t    str += String.fromCharCode(view[i]);","\t\t        if (view[i] > 127) { ","\t\t            isAscii=false; ","\t\t            break; ","\t\t        }","\t\t    }","\t\t    if (isAscii) {","\t\t\t    var stl = Calc.parseSTLString(str);","\t\t\t    console.log('ascii');","\t    \t    Calc.onLoad(stl);","\t\t    } else {","\t\t\t    stl = Calc.parseSTLBinary(buf);","\t    \t    Calc.onLoad(stl);","\t\t    }\t","        };","        reader.readAsArrayBuffer(file);","    },","    ","    parseSTLString: function(str) {","        var totalVol = 0;","\t    // yes, this is the regular expression, matching the vertexes","\t    // it was kind of tricky but it is fast and does the job","\t    var vertexes = str.match(/facet\\s+normal\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+outer\\s+loop\\s+vertex\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+vertex\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+vertex\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+endloop\\s+endfacet/g);","  ","        if (vertexes) {","\t        vertexes.forEach(function (vert) {","\t\t        var preVertexHolder = new Calc.VertexHolder();","\t\t        vert.match(/vertex\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s/g).forEach(function (vertex, i) {","\t\t\t        var tempVertex = vertex.replace('vertex', '').match(/[-+]?[0-9]*\\.?[0-9]+/g);","\t\t\t        var preVertex = new Calc.Vertex(tempVertex[0],tempVertex[1],tempVertex[2]);","\t\t\t        preVertexHolder['vert'+(i+1)] = preVertex;","\t\t        });","\t\t        var partVolume = Calc.triangleVolume(preVertexHolder);","\t\t        totalVol += Number(partVolume);","\t        });","        }","","\t    var volumeTotal = Math.abs(totalVol)/1000;","\t    return { volume: volumeTotal }","    },","    ","    parseSTLBinary: function(buf) {","        var headerLength = 80;","\t    var dataOffset = 84;","\t    var faceLength = 12*4 + 2;","","\t    var le = true; // is little-endian","","\t    var dvTriangleCount = new DataView(buf, headerLength, 4);","\t    var numTriangles = dvTriangleCount.getUint32(0, le);","\t    var totalVol = 0;","","\t    for (var i = 0; i < numTriangles; i++) {","\t\t    var dv = new DataView(buf, dataOffset + i*faceLength, faceLength);","\t\t    var normal = new Calc.Vertex(dv.getFloat32(0, le), dv.getFloat32(4, le), dv.getFloat32(8, le));","\t\t    var vertHolder = new Calc.VertexHolder();","\t\t    for(var v = 3; v < 12; v+=3) {","\t\t\t    var vert = new Calc.Vertex(dv.getFloat32(v*4, le), dv.getFloat32((v+1)*4, le), dv.getFloat32( (v+2)*4, le ) );","\t\t\t    vertHolder['vert'+(v/3)] = vert;","\t\t    }","\t\t    totalVol += Calc.triangleVolume(vertHolder);","\t    }","","\t    var volumeTotal = Math.abs(totalVol)/1000;","\t    return {volume: volumeTotal};","    },","    triangleVolume: function(vertexHolder) {","\t    var ","\t        v321 = Number(vertexHolder.vert3.v1 * vertexHolder.vert2.v2 * vertexHolder.vert1.v3),","\t        v231 = Number(vertexHolder.vert2.v1 * vertexHolder.vert3.v2 * vertexHolder.vert1.v3),","\t        v312 = Number(vertexHolder.vert3.v1 * vertexHolder.vert1.v2 * vertexHolder.vert2.v3),","\t        v132 = Number(vertexHolder.vert1.v1 * vertexHolder.vert3.v2 * vertexHolder.vert2.v3),","\t        v213 = Number(vertexHolder.vert2.v1 * vertexHolder.vert1.v2 * vertexHolder.vert3.v3),","\t        v123 = Number(vertexHolder.vert1.v1 * vertexHolder.vert2.v2 * vertexHolder.vert3.v3);","\t    return Number(1.0/6.0)*(-v321 + v231 + v312 - v132 - v213 + v123);","    },","    ","    Vertex: function(v1,v2,v3) {","\t    this.v1 = Number(v1);","\t    this.v2 = Number(v2);","\t    this.v3 = Number(v3);","    },","    VertexHolder: function(vertex1,vertex2,vertex3) {","\t    this.vert1 = vertex1;","\t    this.vert2 = vertex2;","\t    this.vert3 = vertex3;","    }","};","","$(document).ready(function() {","    var dz = new Dropzone('#dropzone',{ ","        url: \"/\",","        uploadMultiple: false,","        autoProcessQueue: false,","        clickable: '#addfiles',","        maxFilesize: 50,","        maxFiles: 1,","        acceptedFiles: '.stl'","    });","    ","    dz.on(\"addedfile\", function(file) {","        $('#dropzone').html('');","        $('#props').html('<h2 class=\"text-center\">Свойства модели</h2>');","        Calc.readFile(file);","        Order.dz = dz;","    });","});"]}]}],[{"group":"doc","deltas":[{"start":{"row":108,"column":36},"end":{"row":108,"column":37},"action":"remove","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":108,"column":35},"end":{"row":108,"column":36},"action":"remove","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":108,"column":34},"end":{"row":108,"column":35},"action":"remove","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":108,"column":33},"end":{"row":108,"column":34},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":108,"column":32},"end":{"row":108,"column":33},"action":"remove","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":108,"column":31},"end":{"row":108,"column":32},"action":"remove","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":108,"column":30},"end":{"row":108,"column":31},"action":"remove","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":108,"column":29},"end":{"row":108,"column":30},"action":"remove","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":111,"column":18},"end":{"row":111,"column":19},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":111,"column":38},"end":{"row":112,"column":29},"action":"remove","lines":["","        \t\tconsole.log(mtrls);"]}]}],[{"group":"doc","deltas":[{"start":{"row":112,"column":14},"end":{"row":112,"column":15},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":111,"column":38},"end":{"row":112,"column":42},"action":"remove","lines":["","        \t\tmtrl.forEach(function(val,ind) {"]}]}],[{"group":"doc","deltas":[{"start":{"row":115,"column":60},"end":{"row":115,"column":61},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":115,"column":59},"end":{"row":115,"column":60},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":115,"column":58},"end":{"row":115,"column":59},"action":"remove","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":115,"column":58},"end":{"row":115,"column":59},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":115,"column":59},"end":{"row":115,"column":60},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":115,"column":60},"end":{"row":115,"column":61},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":115,"column":61},"end":{"row":115,"column":62},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":118,"column":49},"end":{"row":118,"column":50},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":118,"column":48},"end":{"row":118,"column":49},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":118,"column":47},"end":{"row":118,"column":48},"action":"remove","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":118,"column":47},"end":{"row":118,"column":48},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":118,"column":48},"end":{"row":118,"column":49},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":118,"column":49},"end":{"row":118,"column":50},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":118,"column":50},"end":{"row":118,"column":51},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":122,"column":53},"end":{"row":122,"column":54},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":122,"column":52},"end":{"row":122,"column":53},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":122,"column":51},"end":{"row":122,"column":52},"action":"remove","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":122,"column":51},"end":{"row":122,"column":52},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":122,"column":52},"end":{"row":122,"column":53},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":122,"column":53},"end":{"row":122,"column":54},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":122,"column":54},"end":{"row":122,"column":55},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":122,"column":95},"end":{"row":122,"column":96},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":122,"column":94},"end":{"row":122,"column":95},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":122,"column":93},"end":{"row":122,"column":94},"action":"remove","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":122,"column":93},"end":{"row":122,"column":94},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":122,"column":94},"end":{"row":122,"column":95},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":122,"column":95},"end":{"row":122,"column":96},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":122,"column":96},"end":{"row":122,"column":97},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":41},"end":{"row":125,"column":42},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":40},"end":{"row":125,"column":41},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":39},"end":{"row":125,"column":40},"action":"remove","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":39},"end":{"row":125,"column":40},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":40},"end":{"row":125,"column":41},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":41},"end":{"row":125,"column":42},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":42},"end":{"row":125,"column":43},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":38},"end":{"row":128,"column":13},"action":"remove","lines":["","        \t\t});"]}]}]]},"ace":{"folds":[],"scrolltop":1038,"scrollleft":0,"selection":{"start":{"row":127,"column":38},"end":{"row":127,"column":38},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1428418637960,"hash":"bd9dd011e2d478272512f7eabb369ec3c5794822"}